<!doctype html>
<html lang="en" class="h-screen">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" sizes="any" href="data:;base64,iVBORw0KGgo=" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Harmonia</title>

    <script defer src="/harmonia/lib/node_modules/alpinejs/dist/cdn.min.js"></script>
    <script src="/harmonia/lib/node_modules/lucide/dist/umd/lucide.min.js"></script>
    <script src="/harmonia/lib/node_modules/@codbex/harmonia/dist/harmonia.js"></script>
    <link href="/harmonia/lib/node_modules/@codbex/harmonia/dist/harmonia.css" rel="stylesheet" />
    <link href="/harmonia/fonts.css" rel="stylesheet" />
  </head>
  <body class="vbox h-full p-4" x-data="mainCtl">
    <div
      x-data="{
        value: '',

        get display() {
            return this.value
                ? Number(this.value).toLocaleString()
                : ''
        },

        set display(val) {
            this.value = val.replace(/[^0-9]/g, '')
        }
    }"
    >
      <input type="text" x-model="display" />

      <p>Raw: <span x-text="value"></span></p>
    </div>

    <input class="border" />
    <ul x-h-tree>
      <li x-h-tree-item.expanded="true">
        <button x-h-tree-button data-indicator="positive">
          <i role="img" data-lucide="folder"></i>
          <span>Folder 1</span>
        </button>
        <ul x-h-tree.sub data-border="true">
          <li x-h-tree-item>
            <button x-h-tree-button>
              <i role="img" data-lucide="file-text"></i>
              <span>File 1</span>
            </button>
          </li>
          <li x-h-tree-item.expanded="true">
            <button x-h-tree-button>
              <i role="img" data-lucide="folder"></i>
              <span>Folder 2</span>
            </button>
            <ul x-h-tree.sub data-border="true">
              <li x-h-tree-item>
                <button x-h-tree-button>
                  <i role="img" data-lucide="file-text"></i>
                  <span>File 2</span>
                </button>
              </li>
              <li x-h-tree-item>
                <button x-h-tree-button>
                  <i role="img" data-lucide="file-text"></i>
                  <span>File 3</span>
                </button>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li x-h-tree-item.expanded="true">
        <button x-h-tree-button data-indicator="negative">
          <i role="img" data-lucide="folder"></i>
          <span>Folder 3</span>
        </button>
        <ul x-h-tree.sub data-border="true">
          <li x-h-tree-item>
            <button x-h-tree-button>
              <i role="img" data-lucide="file-text"></i>
              <span>File 4</span>
            </button>
          </li>
          <li x-h-tree-item.expanded="true">
            <button x-h-tree-button>
              <i role="img" data-lucide="folder"></i>
              <span>Folder 4</span>
            </button>
            <ul x-h-tree.sub data-border="true">
              <li x-h-tree-item>
                <button x-h-tree-button>
                  <i role="img" data-lucide="file-text"></i>
                  <span>File 5</span>
                </button>
              </li>
              <li x-h-tree-item>
                <button x-h-tree-button>
                  <i role="img" data-lucide="file-text"></i>
                  <span>File 6</span>
                </button>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li x-h-tree-item>
        <button x-h-tree-button data-indicator="warning">
          <i role="img" data-lucide="file-text"></i>
          <span>File 7</span>
        </button>
      </li>
    </ul>
    <input class="border" />
    <!-- <ul x-h-tree>
      <li x-h-tree-item :data-collapsed="collapsed">
        <button x-h-tree-button @click="collapsed = !collapsed" data-chevron="true">
          <i role="img" data-lucide="folder"></i>
          <span>With subitems</span>
        </button>
        <ul x-h-tree.sub>
          <li x-h-tree-item>
            <button x-h-tree-button>
              <span>Sub Item 1</span>
            </button>
          </li>
          <li x-h-tree-item>
            <button x-h-tree-button data-chevron="true" data-active="true">
              <span>Sub Item 2</span>
            </button>
            <ul x-h-tree.sub>
              <li x-h-tree-item>
                <button x-h-tree-button>
                  <span>Sub Item 3</span>
                </button>
              </li>
              <li x-h-tree-item>
                <button x-h-tree-button>
                  <span>Sub Item 4 </span>
                </button>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul> -->
    <!-- <ul x-tree>
      <li x-treeitem="true">
        <div class="flex items-center gap-2">
          <span>Parent</span>
        </div>

        <ul class="ml-4">
          <li x-treeitem="true">
            <div>Child 1</div>
          </li>

          <li x-treeitem="false">
            <div>Child 2</div>
          </li>
          <li x-treeitem="true">
            <div class="flex items-center gap-2">
              <span>Parent</span>
            </div>

            <ul class="ml-4">
              <li x-treeitem="true">
                <div>Child 1</div>
              </li>

              <li x-treeitem="false">
                <div>Child 2</div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul> -->
    <script>
      lucide.createIcons();
      document.addEventListener("alpine:init", () => {
        Alpine.directive("tree", (el) => {
          el.setAttribute("role", "tree");

          const items = () => [...el.querySelectorAll('[role="treeitem"]')].filter((i) => !i.hasAttribute("disabled"));

          const focusItem = (item) => {
            items().forEach((i) => (i.tabIndex = -1));
            item.tabIndex = 0;
            item.focus();
          };

          el.addEventListener("keydown", (e) => {
            const visibleItems = items().filter((i) => i.offsetParent !== null);
            const current = document.activeElement;
            const index = visibleItems.indexOf(current);

            if (index === -1) return;

            switch (e.key) {
              case "ArrowDown":
                e.preventDefault();
                visibleItems[index + 1] && focusItem(visibleItems[index + 1]);
                break;

              case "ArrowUp":
                e.preventDefault();
                visibleItems[index - 1] && focusItem(visibleItems[index - 1]);
                break;

              case "Home":
                e.preventDefault();
                focusItem(visibleItems[0]);
                break;

              case "End":
                e.preventDefault();
                focusItem(visibleItems[visibleItems.length - 1]);
                break;

              case "ArrowRight":
                e.preventDefault();
                if (current.getAttribute("aria-expanded") === "false") {
                  current.dispatchEvent(new CustomEvent("tree:expand", { bubbles: true }));
                }
                break;

              case "ArrowLeft":
                e.preventDefault();
                if (current.getAttribute("aria-expanded") === "true") {
                  current.dispatchEvent(new CustomEvent("tree:collapse", { bubbles: true }));
                }
                break;
            }
          });
        });

        // ─────────────────────────────────────────────
        // x-treeitem
        // ─────────────────────────────────────────────
        Alpine.directive("treeitem", (el, { expression }, { evaluateLater }) => {
          const getOpen = evaluateLater(expression);

          el.setAttribute("role", "treeitem");
          el.tabIndex = -1;

          const update = () => {
            getOpen((value) => {
              el.setAttribute("aria-expanded", value ? "true" : "false");
            });
          };

          update();

          el.addEventListener("tree:expand", () => {
            getOpen((value) => {
              if (!value) el.dispatchEvent(new CustomEvent("tree:toggle", { bubbles: true }));
            });
          });

          el.addEventListener("tree:collapse", () => {
            getOpen((value) => {
              if (value) el.dispatchEvent(new CustomEvent("tree:toggle", { bubbles: true }));
            });
          });

          // First item focusable by default
          if (!el.closest("[x-treeitem]")) {
            el.tabIndex = 0;
          }
        });
        Alpine.data("mainCtl", () => ({
          collapsed: true,
          expanded: true,
          treeData: [
            {
              id: "src",
              label: "src",
              open: true,
              selected: false,
              children: [
                { id: "index.js", label: "index.js", selected: false },
                { id: "app.css", label: "app.css", selected: false },
              ],
            },
            {
              id: "dist",
              label: "dist",
              open: true,
              selected: false,
              children: [{ id: "index.min.js", label: "index.min.js", selected: false }],
            },
            {
              id: "package.json",
              selected: false,
              label: "package.json",
            },
          ],
        }));
      });
    </script>

    <!--
    <script>

      document.addEventListener("alpine:init", () => {
        Alpine.directive("tree", (el) => {
          el.setAttribute("role", "tree");
        });

        Alpine.directive("tree-node", (el, { expression }, { evaluate }) => {
          let hasChildren = el.querySelector("[data-tree-children]");
          let state = Alpine.reactive({
            open: true,
          });

          el.__x_state = state;

          el.setAttribute("role", "treeitem");
          el.setAttribute("aria-expanded", state.open);

          el.querySelector("[data-tree-toggle]")?.addEventListener("click", () => {
            state.open = !state.open;
            el.setAttribute("aria-expanded", state.open);
          });
        });
        Alpine.data("mainCtl", () => ({
          init() {},
        }));
      });
    </script> -->
  </body>
</html>
