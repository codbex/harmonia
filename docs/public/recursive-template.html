<!doctype html>
<html lang="en" class="h-screen">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" sizes="any" href="data:;base64,iVBORw0KGgo=" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recursive Template</title>

    <script defer src="/harmonia/lib/node_modules/alpinejs/dist/cdn.min.js"></script>
  </head>
  <body x-data="app">
    <ul>
      <template x-for="childNode in tree" :key="childNode.id">
        <template x-h-template="$refs.treeNodeTemplate" x-data="{ node: childNode }"></template>
      </template>
    </ul>

    <template x-ref="treeNodeTemplate">
      <li>
        <span x-text="node.label"></span>

        <template x-if="node.children && node.children.length">
          <ul>
            <template x-for="childNode in node.children" :key="childNode.id">
              <template x-h-template="$refs.treeNodeTemplate" x-data="{ node: childNode }"></template>
            </template>
          </ul>
        </template>
      </li>
    </template>

    <div x-h-test></div>

    <script type="text/javascript">
      document.addEventListener("alpine:init", () => {
        Alpine.directive("h-template", (el, { original, expression }, { evaluate, Alpine, cleanup }) => {
          if (el.hasAttribute(Alpine.prefixed("data"))) {
            const template = evaluate(expression);
            const clone = template.content.cloneNode(true).firstElementChild;
            Alpine.addScopeToNode(clone, Alpine.closestDataStack(el)[0], el.parentElement);
            Alpine.mutateDom(() => {
              el.before(clone);
              Alpine.initTree(clone);
            });
            cleanup(() => {
              clone.remove();
            });
          } else {
            console.error(`${original}: ${Alpine.prefixed("data")} directive is missing`);
          }
        });
        Alpine.data("app", () => ({
          tree: [
            {
              id: "docs",
              label: "Documents",
              children: [
                {
                  id: "harmonia",
                  label: "Harmonia.pdf",
                },
                {
                  id: "alpine",
                  label: "alpine.pdf",
                },
                {
                  id: "tailwind",
                  label: "tailwind.pdf",
                },
              ],
            },
            {
              id: "photos",
              label: "Photos",
              children: [
                {
                  id: "holiday",
                  label: "Holiday",
                  children: [
                    {
                      id: "p1",
                      label: "Photo 1.jpg",
                    },
                    {
                      id: "p2",
                      label: "Photo 2.jpg",
                    },
                    {
                      id: "p3",
                      label: "Photo 3.jpg",
                    },
                  ],
                },
                {
                  id: "img1",
                  label: "Image 1.jpg",
                },
                {
                  id: "img2",
                  label: "Image 2.jpg",
                },
                {
                  id: "img3",
                  label: "Image 3.jpg",
                },
                {
                  id: "img4",
                  label: "Image 4.jpg",
                },
              ],
            },
            {
              id: "hjs",
              label: "harmonia.js",
            },
            {
              id: "hcss",
              label: "harmonia.css",
            },
          ],
          init() {
            setInterval(() => {
              if (this.tree[0].children[this.tree[0].children.length - 1].id === "electrical") {
                this.tree[0].children.pop();
              } else {
                this.tree[0].children.push({
                  id: "electrical",
                  label: "electrical.pdf",
                });
              }
            }, 2000);
          },
        }));
      });
    </script>
  </body>
</html>
